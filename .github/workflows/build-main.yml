name: Build Main

on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    name: Build (${{ matrix.os }}, ${{ matrix.profile }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        profile: [debug, release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Compute version
        id: version
        shell: bash
        run: |
          short_sha="${GITHUB_SHA::7}"
          latest_tag=$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo "v0.0.0")
          latest_tag="${latest_tag#v}"
          version_string="${latest_tag}+${short_sha}"
          echo "short_sha=${short_sha}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=${latest_tag}" >> "$GITHUB_OUTPUT"
          echo "version_string=${version_string}" >> "$GITHUB_OUTPUT"
          echo "## Build Version" >> "$GITHUB_STEP_SUMMARY"
          echo "${version_string}" >> "$GITHUB_STEP_SUMMARY"

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-build-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-${{ matrix.profile }}-
            ${{ runner.os }}-cargo-

      - name: Build
        env:
          MUAT_BUILD_VERSION: ${{ steps.version.outputs.version_string }}
        shell: bash
        run: |
          if [[ "${{ matrix.profile }}" == "release" ]]; then
            cargo build --package atproto-cli --release
          else
            cargo build --package atproto-cli
          fi

      - name: Prepare artifact
        shell: bash
        run: |
          short_sha="${{ steps.version.outputs.short_sha }}"
          artifact_name="atproto-cli-${{ matrix.os }}-${{ matrix.profile }}-${{ github.ref_name }}-${short_sha}"
          mkdir -p dist
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            src="target/${{ matrix.profile }}/atproto.exe"
            dst="dist/atproto.exe"
          else
            src="target/${{ matrix.profile }}/atproto"
            dst="dist/atproto"
          fi
          cp "$src" "$dst"
          echo "${{ steps.version.outputs.version_string }}" > dist/VERSION.txt
          echo "artifact_name=${artifact_name}" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: atproto-cli-${{ matrix.os }}-${{ matrix.profile }}-${{ github.ref_name }}-${{ steps.version.outputs.short_sha }}
          path: dist/*
          retention-days: 14
